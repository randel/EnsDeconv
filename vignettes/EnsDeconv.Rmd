---
title: "EnsDeconv"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{EnsDeconv}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}


# install devtools if necessary
if (!"devtools" %in% rownames(installed.packages())) {
  install.packages('devtools')
}

# if (!require("quadprog")) {
#   install.packages("quadprog", dependencies = TRUE, repos="http://cran.r-project.org")
# }
# if (!require("reshape")) {
#   install.packages("reshape", dependencies = TRUE, repos="http://cran.r-project.org")
# }
# if (!require("e1071")) {
#   install.packages("e1071", dependencies = TRUE, repos="http://cran.r-project.org")
# }
# if (!require("Seurat")) {
#   install.packages("Seurat", dependencies = TRUE, repos="http://cran.r-project.org")
# }
# if (!require("ROCR")) {
#   install.packages("ROCR", dependencies = TRUE, repos="http://cran.r-project.org")
# }
# if (!require("varhandle")) {
#   install.packages("varhandle", dependencies = TRUE, repos="http://cran.r-project.org")
# }
# if (!require("MAST")) {
#   source("https://bioconductor.org/biocLite.R")
#   biocLite("MAST")
# }

# install the EnsDeconv package
#devtools::install_github("randel/EnsDeconv")

library(foreach)
library(tidyverse)
library(EnsDeconv)
data(testdata)
```


The testdata includes two different reference dataset (Nowakowski and Darmanis), and ROS bulk data (n = 10).

Use two reference data, two deconvoluton methods, one normaliztaion, one transformation, one marker gene approach.

```{r}
params = get_params(data_type = "singlecell-rna", data_name = names(testdata$ref_list), n_markers = 50,Marker.Method = "t",TNormalization = "CPM",CNormalization = "CPM",dmeths = c("EPIC","CIBERSORT"))
#generate all possible combinations
#params = get_params(data_type = "singlecell-rna", data_name = names(testdata$ref_list))

res = EnsDeconv(count_bulk = as.matrix(testdata$count_bulk), ref_list = testdata$ref_list, ncore = 4, parallel_comp = T, params = params,trueMet = "ROS",outpath = "./tmp/")


pheatmap::pheatmap(res[["EnsDeconv"]][["ensemble_p"]],cluster_rows = F,cluster_cols = F)
```

